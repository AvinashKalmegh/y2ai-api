name: Hypergraph Regime-Aware Analysis

on:
  schedule:
    # Run every 2 hours during market hours (9 AM - 6 PM ET = 14:00 - 23:00 UTC)
    - cron: '30 14 * * 1-5'  # 9:30 AM ET
    - cron: '30 16 * * 1-5'  # 11:30 AM ET  
    - cron: '30 18 * * 1-5'  # 1:30 PM ET
    - cron: '30 20 * * 1-5'  # 3:30 PM ET
    - cron: '30 22 * * 1-5'  # 5:30 PM ET (main after-close run)
    - cron: '30 0 * * 2-6'   # 7:30 PM ET (evening follow-up)
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run regardless of staleness'
        required: false
        default: 'false'
        type: boolean

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  TZ: America/New_York
  PYTHONPATH: ${{ github.workspace }}/y2ai

jobs:
  check-regime:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.regime-check.outputs.should_run }}
      regime: ${{ steps.regime-check.outputs.regime }}
      staleness: ${{ steps.regime-check.outputs.staleness }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install supabase python-dotenv
      
      - name: Check regime and staleness
        id: regime-check
        env:
          PYTHONPATH: ${{ github.workspace }}/y2ai
        run: |
          if [ "${{ github.event.inputs.force_run }}" == "true" ]; then
            echo "Force run requested"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "regime=FORCED" >> $GITHUB_OUTPUT
            echo "staleness=forced" >> $GITHUB_OUTPUT
          else
            cd y2ai
            python -c "
from hypergraph.regime_scheduler import should_update_hypergraph
result = should_update_hypergraph()
print(f\"SHOULD_RUN={'true' if result['should_run'] else 'false'}\")
print(f\"REGIME={result['current_regime']}\")
print(f\"STALENESS={result['staleness_hours']:.1f}h\")
" | tee /tmp/regime_output.txt
            
            SHOULD_RUN=$(grep "SHOULD_RUN=" /tmp/regime_output.txt | cut -d= -f2)
            REGIME=$(grep "REGIME=" /tmp/regime_output.txt | cut -d= -f2)
            STALENESS=$(grep "STALENESS=" /tmp/regime_output.txt | cut -d= -f2)
            
            echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
            echo "regime=$REGIME" >> $GITHUB_OUTPUT
            echo "staleness=$STALENESS" >> $GITHUB_OUTPUT
          fi
      
      - name: Log decision
        run: |
          echo "========================================"
          echo "REGIME SCHEDULER DECISION"
          echo "Should Run: ${{ steps.regime-check.outputs.should_run }}"
          echo "Regime: ${{ steps.regime-check.outputs.regime }}"
          echo "Staleness: ${{ steps.regime-check.outputs.staleness }}"
          echo "========================================"

  hypergraph-analysis:
    needs: check-regime
    if: needs.check-regime.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install yfinance pandas numpy networkx supabase python-dotenv
      
      - name: Log run context
        run: |
          echo "HYPERGRAPH UPDATE"
          echo "Regime: ${{ needs.check-regime.outputs.regime }}"
          echo "Staleness: ${{ needs.check-regime.outputs.staleness }}"
      
      - name: Run Hypergraph Pipeline
        working-directory: y2ai
        run: python -m hypergraph.pipeline
      
      - name: Run Bubble Radar
        working-directory: y2ai
        run: python -m hypergraph.radar

  skip-notification:
    needs: check-regime
    if: needs.check-regime.outputs.should_run == 'false'
    runs-on: ubuntu-latest
    
    steps:
      - name: Log skip reason
        run: |
          echo "HYPERGRAPH UPDATE SKIPPED"
          echo "Regime: ${{ needs.check-regime.outputs.regime }}"
          echo "Staleness: ${{ needs.check-regime.outputs.staleness }}"